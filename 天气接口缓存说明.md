# 天气接口缓存说明

## 功能说明

天气接口已迁移到后端，并实现了**每日缓存机制**，每天只调用一次天气API，大大节省API调用额度。

## 工作原理

1. **首次请求**：当第一次请求天气数据时，后端会调用心知天气API获取数据，并将结果缓存到内存中
2. **缓存有效期**：缓存在同一天内有效，只要日期不变，后续请求都直接返回缓存数据
3. **自动更新**：每天第一次请求时，如果缓存已过期，会自动调用API更新缓存
4. **降级处理**：如果API调用失败，会尝试返回过期缓存（如果有的话）

## 接口说明

### 1. 获取所有天气数据（推荐）

**接口**：`GET /api/weather/all`

**说明**：一次性获取北京和洛阳两个城市的天气数据

**响应示例**：
```json
{
  "status": "success",
  "data": {
    "beijing": {
      "location": { "name": "北京" },
      "daily": [...]
    },
    "luoyang": {
      "location": { "name": "洛阳" },
      "daily": [...]
    },
    "cached": true  // 是否为缓存数据
  }
}
```

### 2. 获取北京天气

**接口**：`GET /api/weather/beijing`

### 3. 获取洛阳天气

**接口**：`GET /api/weather/luoyang`

## 配置

### 环境变量（可选）

在 `zhuangxiu-backend/.env` 文件中可以配置天气API密钥：

```env
WEATHER_API_KEY=your-api-key-here
```

如果不配置，会使用默认密钥（但建议使用自己的密钥）。

## 前端使用

前端代码已自动更新，现在调用后端接口而不是直接调用天气API：

```javascript
// 在 Home.jsx 中
import { weatherAPI } from '../services/api';

const fetchWeatherData = async () => {
  const response = await weatherAPI.getAll();
  if (response.status === 'success') {
    setBeijingWeather(response.data.beijing);
    setLuoyangWeather(response.data.luoyang);
  }
};
```

## 缓存效果

- **之前**：每次进入首页都会调用2次天气API（北京+洛阳）
- **现在**：每天只调用2次天气API（首次请求时），后续请求都使用缓存

**节省效果**：
- 如果每天有10个用户访问首页，之前需要调用 10 × 2 = 20 次API
- 现在只需要调用 2 次API（每天首次请求时）
- **节省了 90% 的API调用量！**

## 注意事项

1. **缓存是内存缓存**：服务器重启后缓存会清空，需要重新获取
2. **时区问题**：缓存基于服务器本地时区的日期判断
3. **多实例部署**：如果使用多实例部署，每个实例有独立的缓存（建议使用Redis实现共享缓存）

## 未来优化建议

如果需要更高级的缓存功能，可以考虑：

1. **使用Redis**：实现跨实例的共享缓存
2. **持久化缓存**：将缓存保存到数据库，服务器重启后仍可使用
3. **缓存预热**：在服务器启动时或定时任务中预先获取天气数据
