# 大模型集成说明

## 配置

### 1. 安装依赖

在 `zhuangxiu-backend` 目录下运行：

```bash
npm install axios
```

### 2. 环境变量配置

在 `zhuangxiu-backend/.env` 文件中添加以下配置：

```env
# 大模型配置
LLM_API_URL=http://127.0.0.1:1234/v1/chat/completions
LLM_MODEL=local-model
```

**注意**：`LLM_API_URL` 应该指向您的本地大模型服务地址。

## 已实现的功能

### 1. 合同智能审核

**接口**：`POST /api/contracts/:id/analyze`

**功能**：
- 自动识别合同中的霸王条款、模糊条款、风险点
- 提取合同核心信息（公司信息、金额、工期、付款节点等）
- 提供具体的修改建议和注意事项

**使用示例**：
```javascript
// 前端调用
const response = await fetch(`http://localhost:5001/api/contracts/${contractId}/analyze`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});
const result = await response.json();
```

**返回格式**：
```json
{
  "status": "success",
  "message": "合同审核完成",
  "data": {
    "contract": {...},
    "analysis": {
      "risks": [
        {
          "type": "霸王条款",
          "content": "具体风险内容",
          "severity": "high",
          "suggestion": "修改建议"
        }
      ],
      "summary": {
        "companyName": "装修公司名称",
        "contractAmount": "合同金额",
        "constructionPeriod": "工期",
        "paymentSchedule": "付款节点",
        "warrantyPeriod": "质保期限"
      },
      "suggestions": ["建议1", "建议2"]
    }
  }
}
```

### 2. 设计图还原度评估

**接口**：`POST /api/designs/:id/evaluate`

**功能**：
- 从5个维度评估设计还原度（色彩、尺寸、材质、造型、软装）
- 生成综合评分（0-100分）
- 识别差异点并提供改进建议

**使用示例**：
```javascript
// 前端调用
const response = await fetch(`http://localhost:5001/api/designs/${designId}/evaluate`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});
const result = await response.json();
```

**返回格式**：
```json
{
  "status": "success",
  "message": "还原度评估完成",
  "data": {
    "design": {...},
    "evaluation": {
      "scores": {
        "colorMatch": 85,
        "sizeMatch": 90,
        "materialMatch": 80,
        "shapeMatch": 88,
        "decorationMatch": 82
      },
      "overallScore": 85,
      "differences": [
        {
          "aspect": "色彩",
          "description": "窗帘颜色与效果图略有差异",
          "suggestion": "建议调整窗帘颜色"
        }
      ],
      "strengths": ["吊顶造型还原度较高"],
      "improvements": ["建议调整窗帘颜色"]
    }
  }
}
```

### 3. 智能预算生成

**接口**：`POST /api/budget/generate`

**功能**：
- 根据户型、面积、风格、城市、档次生成详细预算
- 自动拆分各分类预算（人工、材料、设计、其他）
- 提供预算建议和注意事项

**请求参数**：
```json
{
  "houseType": "apartment",
  "area": 120,
  "style": "modern",
  "city": "北京",
  "level": "standard"
}
```

**使用示例**：
```javascript
// 前端调用
const response = await fetch('http://localhost:5001/api/budget/generate', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    houseType: 'apartment',
    area: 120,
    style: 'modern',
    city: '北京',
    level: 'standard'
  })
});
const result = await response.json();
```

**返回格式**：
```json
{
  "status": "success",
  "message": "预算生成成功",
  "data": {
    "totalBudget": 150000,
    "breakdown": {
      "labor": {
        "amount": 45000,
        "percentage": 30,
        "items": ["水电工", "泥瓦工", "木工", "油漆工"]
      },
      "materials": {
        "amount": 60000,
        "percentage": 40,
        "items": ["瓷砖", "地板", "涂料", "门窗"]
      },
      "design": {
        "amount": 15000,
        "percentage": 10,
        "items": ["设计费", "效果图"]
      },
      "other": {
        "amount": 30000,
        "percentage": 20,
        "items": ["管理费", "杂费"]
      }
    },
    "recommendations": [
      "建议预留10-15%的弹性预算"
    ],
    "warning": "此预算为参考值，实际费用可能因市场波动有所不同"
  }
}
```

## 前端集成建议

### 1. 在合同管理页面添加审核按钮

在 `ContractManagement.jsx` 中添加：

```javascript
const analyzeContract = async (contractId) => {
  try {
    setLoading(true);
    const response = await contractAPI.analyze(contractId);
    if (response.status === 'success') {
      message.success('合同审核完成');
      // 显示审核结果
      Modal.info({
        title: '合同审核结果',
        content: (
          <div>
            <h4>风险识别：</h4>
            {response.data.analysis.risks.map((risk, index) => (
              <div key={index}>
                <Alert message={risk.content} type={risk.severity === 'high' ? 'error' : 'warning'} />
                <p>建议：{risk.suggestion}</p>
              </div>
            ))}
            <h4>修改建议：</h4>
            <ul>
              {response.data.analysis.suggestions.map((suggestion, index) => (
                <li key={index}>{suggestion}</li>
              ))}
            </ul>
          </div>
        ),
        width: 800
      });
    }
  } catch (error) {
    message.error('合同审核失败');
  } finally {
    setLoading(false);
  }
};
```

### 2. 在设计对比页面添加评估按钮

在 `DesignComparison.jsx` 中添加：

```javascript
const evaluateDesign = async (designId) => {
  try {
    setLoading(true);
    const response = await designAPI.evaluate(designId);
    if (response.status === 'success') {
      message.success('还原度评估完成');
      // 显示评估结果
      const { evaluation } = response.data;
      Modal.info({
        title: '还原度评估结果',
        content: (
          <div>
            <Statistic title="综合评分" value={evaluation.overallScore} suffix="分" />
            <Divider />
            <h4>各维度评分：</h4>
            <Progress percent={evaluation.scores.colorMatch} title="色彩匹配度" />
            <Progress percent={evaluation.scores.sizeMatch} title="尺寸比例" />
            <Progress percent={evaluation.scores.materialMatch} title="材质一致性" />
            <Progress percent={evaluation.scores.shapeMatch} title="造型还原度" />
            <Progress percent={evaluation.scores.decorationMatch} title="软装摆放" />
            <h4>改进建议：</h4>
            <ul>
              {evaluation.improvements.map((item, index) => (
                <li key={index}>{item}</li>
              ))}
            </ul>
          </div>
        ),
        width: 600
      });
    }
  } catch (error) {
    message.error('还原度评估失败');
  } finally {
    setLoading(false);
  }
};
```

### 3. 更新预算管理页面

在 `BudgetManagement.jsx` 中，将现有的 `generateBudget` 函数改为调用API：

```javascript
const generateBudget = async (values) => {
  try {
    setBudgetLoading(true);

    // 调用后端API
    const response = await fetch('http://localhost:5001/api/budget/generate', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(values)
    });

    const result = await response.json();

    if (result.status === 'success') {
      setBudget(result.data);
      message.success('预算生成成功');
    } else {
      message.error(result.message || '预算生成失败');
    }
  } catch (error) {
    message.error('预算生成失败');
    console.error('Generate budget error:', error);
  } finally {
    setBudgetLoading(false);
  }
};
```

## API 服务封装

在 `zhuangxiu-frontend/src/services/api.js` 中添加：

```javascript
export const contractAPI = {
  // ... 现有方法
  analyze: (id) => api.post(`/contracts/${id}/analyze`)
};

export const designAPI = {
  // ... 现有方法
  evaluate: (id) => api.post(`/designs/${id}/evaluate`)
};

export const budgetAPI = {
  generate: (data) => api.post('/budget/generate', data)
};
```

## 注意事项

1. **大模型服务**：确保本地大模型服务正在运行，并且API地址正确
2. **超时设置**：大模型调用设置了30秒超时，如果响应较慢可以调整
3. **错误处理**：如果大模型服务不可用，会返回错误信息，前端需要做好错误提示
4. **JSON解析**：大模型返回的JSON可能包含额外文本，代码会自动提取JSON部分
5. **降级处理**：如果大模型调用失败，部分功能会使用默认计算逻辑作为降级方案

## 测试

1. 启动后端服务：`cd zhuangxiu-backend && npm run dev`
2. 确保大模型服务运行在 `http://127.0.0.1:1234`
3. 使用Postman或前端页面测试各个接口
